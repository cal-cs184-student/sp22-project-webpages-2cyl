<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bgcolor: #2b3958;
      --fgcolor: #bccbef;
      --highlight: #e1cf67;
      font-family: 'Roboto Mono';
      font-weight: 300;
      -webkit-print-color-adjust: exact;
    }

    body {
      padding: 60px;
      width: 800px;
      margin: auto;
      text-align: left;
      font-size: small;
      /* font-family: 'Roboto Mono'; */
      color: var(--fgcolor);
      background-color: var(--bgcolor);
      text-align: justify;
      text-justify: inter-word;

    }

    button {
      background-color: var(--fgcolor);
      border: none;
      font-weight: bold;
      text-decoration: none;
      color: var(--bgcolor);
      padding: 5px 10px;
      margin: 2px 2px;
      cursor: pointer;
    }

    h1 {
      font-size: x-large;
    }

    h2 {
      font-size: large;
      color: var(--highlight);
    }

    h3 {
      font-size: medium;
      color: var(--highlight);
    }

    h4,
    figcaption {
      font-size: small;
    }

    code {
      font-size: medium;
      display: inline-block;
      background: #2d423f;
    }

    a {
      color: var(--fgcolor);
    }

    /* width */
    ::-webkit-scrollbar {
      width: 8px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: var(--fgcolor);
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: var(--bgcolor);
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: var(--bgcolor);
    }

    ::selection {
      color: var(--highlight);
      background: var(--highlight);
    }
  </style>
  <div align="middle">
    <a href="../proj1/index.html"><button>P1</button></a>
    <a href="../proj2/index.html"><button>P2</button></a>
    <a href="../proj3-1/index.html"><button>P3-1</button></a>
    <a href="../proj3-2/index.html"><button>P3-2</button></a>
    <a href="../proj4/index.html"><button>P4</button></a>
    <a href="../projfinal/index.html"><button>PF</button></a>
    <a href="../projfinal-milestone/"><button>PF</button></a>
  </div>
  <br>
  <title>CS 184 Final Project Report: Fluid Simulation using Material Point Method</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

  <!-- mathjax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>


<body>

  <h1 align="middle">CS 184: Computer Graphics and Imaging [SP22]</h1>
  <h1 align="middle">Fluid Simulation using Material Point Method</h1>
  <h3 align="middle">Alan Hernandez, Clare Lin, Faywer Liu, Medhaav Chandra Mahesh</h2>

    <br>
    <h2 align="middle">Abstract</h2>
    <p>
      
    </p>

    <br>



    <h2 align="middle">Technical Approach</h2>
    <p>
      Many common simulations methods use either a Langrangian approach (particle based) or a 
      Eulerian approach (grid based). MPM uses both as it first maps particles to the grid, does grid calculations,
      then maps the grid back to the particles and finally particle calculations are done.
    </p>
    <p>
      To interpolate from particle to cell or from cell to particle, we use the unifiorm GIMP as our shape function N defined below.
      $$N_{I}(x_{j}) = S_{I}(\frac{|x_{j,x}-x_{I,x}|}{h})S_{I}(\frac{|x_{j,y}-x_{I,y}|}{h})S_{I}(\frac{|x_{j,z}-x_{I,z}|}{h})$$

      $$S_I(x)=
      \begin{cases} 
          \frac{7-16x^{2}}{16} & x\leq .25 \\
          1-x & .25 < x\leq .75 \\
          \frac{(5-4x)^{2}}{16} & .75 < x\leq 1.25 \\
          0 & otherwise 
      \end{cases}$$
    <p>
      where x_j is the position of the partcle, x_j,d is the position in a dimension where d is x, y, or z, x_I is the position of the cell,
      and h is the grid size.
    </p>
    <p>
      In each simulation step, we first began by clearing the cell.
    </p>
    <h4 align="middle">Particle to Grid</h4>
    <p>
      Next loop through all particles
      and calculate the mass and momentum for the corresponding cell using the equations below.
    </p>
    <p>
      $$m_{I} = \sum_{j \in H_I}m_{j}N_{I}(x_j)$$
      m_I is the mass of the cell, j is a particle in the vicinity of the cell, m_j is the particle mass,
      and N_I is the shape function defined above.
    </p>
    <p>
      $$p_{I} = \sum_{j \in H_I}v_{j}m_{j}N_{I}(x_j)$$
      p_I is the momentum of the cell. This equation is similar except we include the velocity of the particles ss well.
    </p>
    <h4 align="middle">Fluid and Grid Calculations</h4>
      <p>
        Once we have mapped our particles to cells, we want to do our grid calculations. Liquids are considered
        incompressible so we solve the following differential equations that govern non-viscous fluids.
      </p>
      <p>
        $$ \frac{D\rho}{Dt} = 0 $$

        $$ \rho\frac{Du}{Dt}=-\Delta p + \rho g$$

        where ρ is the density, u is the velocity, and p is the pressure, and g is external body forces.
      </p>
      <p>
        A solution to the differential equations above is given below.
      </p>
      <p>
        We first want to calculate the fluid density of each cell. This is done by looping through every particle
        within the victinity of the cell.
      </p>
      <p>
        $$\rho(x)=\sum_{j \in H}\frac{m_{j}N_{I}(x_{j})}{V_{j}}$$
        rho is the fluid density, x is the position of the cell, j is a particle within the vicinity of the cell, m_j is the
        mass of the particle and V_j is the volume of the particle.
      </p>
      <p>
        Using the fluid density allows us to calculate the fluid pressure of each particle using the weakly compressible eqaution.
      </p>
      <p>
        $$ p_{i}=k_{s}((\frac{\rho_i}{\bar{\rho}})^7 - 1)$$
        where p_i is the fluid pressure of a particle, k_s is the stiffness coefficient, ρ_i is the fluid density, and ρ^- is the rest density.
      </p>
      Finally we can calculate the pressure forces that act upon the cells.
      <p>
        $$ f_{I, pressure}=\sum_{j \in H_{i}}\frac{m_j}{\rho_j}p_j\Delta N_{I}(x_j)$$
        where f_I, pressure is the pressure force, m_j is the particle mass, ρ_j is the fluid density, p_j is the fluid pressure,
        and ∇N_i is the gradient of the shape function.
      </p>
      <p>
        We can also apply external forces now such as gravity to each node.
      </p>
      <h4 align="middle">Grid to Particles</h4>
      <p>
        We now map the cell values to particles. The velocity and acceleration of particles are given below.
        This is calculated by looping through the particles and summing up values of cells in its vicinity.
      </p>
      <p>
        $$a_{i} = \sum_{J \in H_I}\frac{f_{J}N_{J}(x_i)}{m_{J}}$$
        where F_J is the sum of the forces that act upon cell J and m_J is the mass of the cell
      </p>
      <p>
        $$u_{i} = \sum_{J \in H_I}\frac{p_{J}N_{J}(x_i)}{m_{J}}$$
      </p>
      <h4 align="middle">Particle Calculations</h4>
      <p>
        We can now do our particle calculations to determine the position of the particle.
      </p>
      <p>
        To calculate the new velocity, we use the following equations.
      </p>
      <p>
        $$\bar{u_{i}}=a_{i}dt+u_{i}^{old}$$
        $$ u_{i}^{new}=\alpha u_{i}+(1 - \alpha)\bar{u}_{i}$$
        where α is .05 to give more weight towards the updated velocity.
      </p>
      <p>
        Finally, the position is updated using
      </p>
     <p>$$ x^{t + \Delta t}=x^{t}+\Delta tu^{new}$$</p>
      </p>

    <h4 align="middle">Algorithm Summary / Work Flow</h4>
    <dl>
      <dt>build grid by initializing all particles in a random position within a cube</li>
      <dt>while simulation</dt>
      <dt>&nbsp reset the grid</dt>
      <dt>&nbsp for every particle</dt>
      <dt>&nbsp &nbsp map mass and momentum to a cell of the grid</dt>
      <dt>&nbsp for every cell</dt>
      <dt>&nbsp &nbsp calculate fluid density for every particle in cell</dt>
      <dt>&nbsp &nbsp calculate cell's pressure force (pressure gradient)</dt>
      <dt>&nbsp for every cell</dt>
      <dt>&nbsp &nbsp apply gravity to cell</dt>
      <dt>&nbsp &nbsp for every particle inside cell</dt>
      <dt>&nbsp &nbsp &nbsp apply cell accerlation and cell velocity to partcle inside cell</dt>
      <dt>&nbsp for every particle</dt>
      <dt>&nbsp &nbsp calculate velocity and position using equation</dt>
    </dl>

    <h2 align="middle">Difficulties and Lessons Learned</h2>
    <p>
      Our biggest difficulties is that our fluids are not incompressible as shown below. 
    </p>

    <table style="width:100%">
      <tbody>
        <tr>
          <td>
            <img src="images/gravity.gif" align="middle" width="400px">
            <figcaption align="middle">Just Gravity</figcaption>
          </td>
          <td>
            <img src="images/pressure.gif" align="middle" width="400px">
            <figcaption align="middle">Just Pressure Forces</figcaption>
          </td>
        </tr>
      </tbody>
    </table>

    <div align="middle">
      <img src="images/both.gif" align="middle" width="400px">
      <figcaption align="middle">Both Gravity and Pressure Forces</figcaption>
    </div>

    <p>
      As we can see, gravity seems to be working as intended while the pressure forces do not. This pressure force seems to be
      stronger than gravity and pulls everything in a (-, -, -) direction. An explanation of this can be from the f_I, pressure equation
      where we take the gradient of the shape function. Notice that the shape function returns either 0 or a positive value but the derivatives
      of it returns either 0 or a negative value. This could explain why this force seems to pull in the (-, -, -) direction.
    </p>

    <p>
      The fluid section of the paper is a bit handwavy so it's possible that we misunderstand it. This paper requires a lot of physics
      knowledge which we don't have a background in. 
    </p>

    <p>
      Unlike ClothSim where we just had to implement the physics and shaders, we had to directly interact with OpenGL; however, we had issues with NanoGui's OpenGL. Our first issue was that with a large number of particles,
      drawing spheres would be extremely demanding and the program would crash with about 5000 spheres. 
    </p>

    <div align="middle">
      <img src="images/bad.png" align="middle" width="400px">
      <figcaption align="middle">The collision plane seems to follow and scale with our spheres???</figcaption>
    </div>

    <p>
      To remedy this, we decided to draw a simple triangle for each particle. This allowed us to draw 
      about 30,000 particles without any issue. This also fixed the problem where the plane would follow the first particle.
    </p>

    <p>
      The OpenGL that NanoGui uses is missing a lot of functionality. For instance fundamental OpenGL constants like GL_MODELVIEW_MATRIX 
      were not defined. This also made many online OpenGL tutorials useless since they would not build. We couldn't find any solutions to this
      and moved on to more important things.
    </p>

    <p>
      Learning how to use the many libraries such as CGL and Eigen proved to be difficult. The skeleton code uses them both which is a bit confusing.
      Some of these issues could have been fixed if we used something such as the Taichi where the GUI and matrix data structures are built in so 
      we could directly focus on the physics.
    </p>


    <h2 align="middle">Results</h2>
    <h4 align="middle">Compressibility</h2>
    <p>
      While we unfortately could not figure out how to keep the fluid incompressible by not allowing particle clumping, 
      we do have some interesting compressible fluids. By changing some constants such as the grid size, or KS we have some differing results.
    </p>

    <table style="width:100%">
      <tbody>
        <tr>
          <td>
            <img src="images/weird.gif" align="middle" width="400px">
            <figcaption align="middle">Small KS</figcaption>
          </td>
          <td>
            <img src="images/weird3.gif" align="middle" width="400px">
            <figcaption align="middle">Medium KS</figcaption>
          </td>
        </tr>
      </tbody>
    </table>

    <table style="width:100%">
      <tbody>
        <tr>
          <td>
            <img src="images/weird1.gif" align="middle" width="400px">
            <figcaption align="middle">Large KS</figcaption>
          </td>
          <td>
            <img src="images/weird2.gif" align="middle" width="400px">
            <figcaption align="middle">Grid Size = 32</figcaption>
          </td>
        </tr>
      </tbody>
    </table>



    <h4 align="middle">Frame saver</h4>
    <p>

    </p>

    <h4 align="middle">Video</h2>
      <div align="middle">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/9nK1LsOMfpM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    
    <h2 align="middle">References</h2>
    <p>
      <a href="https://cg.cs.tsinghua.edu.cn/papers/CGF-2018-mpm-fluid-solid.pdf"> “MPM simulation of interacting fluids and solids”</a>
      </p>
      

    <h2 align="middle">Contributions</h2>
    <ul>
      <li>Alan worked on </li>
      <li>Clare worked on</li>
      <li>Faywer worked on</li>
      <li>Medhaav worked on</li>
    </ul>
    <br>


    
</body>

</html>